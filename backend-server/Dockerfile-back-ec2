# --- STAGE 1: 빌드 (JDK 포함 이미지) ---
FROM eclipse-temurin:21-jdk-jammy AS build
WORKDIR /app

# 1. Gradle 설정 파일들 복사 (캐싱 효율을 위해 소스보다 먼저 복사)
COPY gradlew .
COPY gradle gradle
COPY build.gradle settings.gradle .

# 2. Windows 줄바꿈 문자(\r) 제거 및 실행 권한 부여 (Cross-Platform 핵심)
RUN sed -i 's/\r$//' gradlew && chmod +x gradlew

# 3. 종속성 설치 (소스 복사 전에 실행하여 캐싱 활용)
RUN ./gradlew dependencies --no-daemon

# 4. 소스 복사 및 실제 빌드
COPY src src
RUN ./gradlew bootJar -x test --no-daemon

# --- STAGE 2: 실행 (JRE만 있는 가벼운 이미지) ---
FROM eclipse-temurin:21-jre-alpine AS final

# 보안을 위해 root가 아닌 별도 유저 생성 및 전환
RUN addgroup -S spring && adduser -S spring -G spring
USER spring

WORKDIR /app
# STAGE 1에서 빌드된 jar 파일만 가져옴
COPY --from=build /app/build/libs/*.jar app.jar

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]